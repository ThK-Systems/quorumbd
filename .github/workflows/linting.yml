name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:

jobs:
  lint:
    name: Lint (Go 1.26.x)
    runs-on: ubuntu-latest

    env:
      GOWORK: ${{ github.workspace }}/go.work

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go 1.26.x
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.x"
          check-latest: true
          cache: true
          cache-dependency-path: |
            common/go.sum
            core/go.sum
            middleware-qemu-nbd/go.sum

      - name: Verify Go + workspace
        run: |
          set -euo pipefail
          go version
          go env GOVERSION | grep '^go1\.26\.'
          test -f "$GOWORK"
          go env GOWORK
          go work sync
          go list -m all

      - name: Verify formatting (gofmt)
        run: |
          set -euo pipefail
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "Unformatted files:"
            echo "$UNFORMATTED"
            exit 1
          fi

      - name: Install golangci-lint
        run: |
          set -euo pipefail
          # v2.x hat Go 1.26 Support (siehe Changelog). :contentReference[oaicite:0]{index=0}
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@v2.10.0

      # -------- common (lib) --------
      - name: go vet (common)
        working-directory: common
        run: |
          set -euo pipefail
          go vet ./...

      - name: golangci-lint (common)
        working-directory: common
        run: |
          set -euo pipefail
          golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...

      # -------- core (main) --------
      - name: go vet (core)
        working-directory: core
        run: |
          set -euo pipefail
          go vet ./...

      - name: golangci-lint (core)
        working-directory: core
        run: |
          set -euo pipefail
          golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...

      # -------- middleware-qemu-nbd (main) --------
      - name: go vet (middleware-qemu-nbd)
        working-directory: middleware-qemu-nbd
        run: |
          set -euo pipefail
          go vet ./...

      - name: golangci-lint (middleware-qemu-nbd)
        working-directory: middleware-qemu-nbd
        run: |
          set -euo pipefail
          golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...
