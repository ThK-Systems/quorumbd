name: Lint

on: [push, pull_request, workflow_dispatch]

jobs:
  lint:
    name: Lint (Go 1.26.x)
    runs-on: ubuntu-latest

    env:
      GOWORK: ${{ github.workspace }}/go.work

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go 1.26.x
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.x"
          check-latest: true
          cache: true
          cache-dependency-path: |
            common/go.sum
            core/go.sum
            middleware-qemu-nbd/go.sum

      - name: Verify Go + workspace
        run: |
          set -euo pipefail
          go version
          go env GOVERSION | grep '^go1\.26\.'
          test -f "$GOWORK"
          go env GOWORK
          go work sync
          go list -m all

      - name: Verify formatting (gofmt)
        run: |
          set -euo pipefail
          UNFORMATTED=$(gofmt -l .)
          if [ -n "$UNFORMATTED" ]; then
            echo "Unformatted files:"
            echo "$UNFORMATTED"
            exit 1
          fi

      - name: Build (core)
        working-directory: core
        run: |
          set -euo pipefail
          mkdir -p ../.ci-bin
          go build -o ../.ci-bin/quorumbd-core .

      - name: Build (middleware-qemu-nbd)
        working-directory: middleware-qemu-nbd
        run: |
          set -euo pipefail
          mkdir -p ../.ci-bin
          go build -o ../.ci-bin/quorumbd-middleware-qemu-nbd .

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.10.1

      - name: golangci-lint (common)
        working-directory: common
        run: golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...

      - name: golangci-lint (core)
        working-directory: core
        run: golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...

      - name: golangci-lint (middleware-qemu-nbd)
        working-directory: middleware-qemu-nbd
        run: golangci-lint run --config ../.golangci.yml --timeout=5m --modules-download-mode=readonly ./...
